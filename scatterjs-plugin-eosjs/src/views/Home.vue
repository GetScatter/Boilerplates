<template>
  <section class="example">

    <section class="container">
      <section class="scatter-logo">
        <svg viewBox="0 0 202 208" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">

          <desc>Scatter Logo</desc>
          <defs>
            <circle id="path-1" cx="95" cy="95" r="87"></circle>
            <filter x="-15.5%" y="-8.6%" width="131.0%" height="131.0%" filterUnits="objectBoundingBox" id="filter-2">
              <feOffset dx="0" dy="12" in="SourceAlpha" result="shadowOffsetOuter1"></feOffset>
              <feGaussianBlur stdDeviation="7" in="shadowOffsetOuter1" result="shadowBlurOuter1"></feGaussianBlur>
              <feColorMatrix values="0 0 0 0 0.269792798   0 0 0 0 0.513949697   0 0 0 0 0.686543367  0 0 0 0.482053895 0" type="matrix" in="shadowBlurOuter1"></feColorMatrix>
            </filter>
          </defs>
          <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g id="gs_home_02a" transform="translate(-619.000000, -221.000000)">
              <g id="Group-15" transform="translate(625.000000, 221.000000)">
                <circle id="Oval-2" fill="#FFFFFF" cx="95" cy="95" r="95"></circle>
                <g id="Oval-2-Copy">
                  <use fill="black" fill-opacity="1" filter="url(#filter-2)" xlink:href="#path-1"></use>
                  <use fill="#FBFBFB" fill-rule="evenodd" xlink:href="#path-1"></use>
                </g>
                <path d="M89.4579327,147 C86.4891678,147 84.0228464,146.667435 82.0588942,146.002294 C80.0949421,145.337153 78.542073,144.591747 77.4002404,143.766055 C76.2584078,142.940363 75.4591369,142.149086 75.0024038,141.392202 C74.5456708,140.635317 74.3173077,140.142203 74.3173077,139.912844 C74.3173077,139.087152 74.4999982,138.204133 74.8653846,137.263761 C75.2307711,136.32339 75.6874973,135.451839 76.2355769,134.649083 C76.7836566,133.846326 77.3774006,133.169728 78.0168269,132.619266 C78.6562532,132.068805 79.2271609,131.793578 79.7295673,131.793578 C80.3689936,131.793578 80.8942287,132.206418 81.3052885,133.03211 L81.9903846,133.720183 C82.3557711,134.087158 82.869588,134.465594 83.531851,134.855505 C84.1941139,135.245415 85.0162211,135.600916 85.9981971,135.922018 C86.9801732,136.243121 88.1334068,136.40367 89.4579327,136.40367 C92.3353509,136.40367 94.6874909,135.520651 96.5144231,133.754587 C98.3413553,131.988523 99.2548077,129.591758 99.2548077,126.56422 C99.2548077,124.454118 98.763827,122.573403 97.781851,120.922018 C96.7998749,119.270634 95.5096234,117.733952 93.9110577,116.311927 C92.312492,114.889901 90.4855872,113.5023 88.4302885,112.149083 C86.3749897,110.795865 84.2740492,109.385328 82.1274038,107.917431 C79.9807585,106.449534 77.879818,104.866981 75.8245192,103.169725 C73.7692205,101.472469 71.9423157,99.5229468 70.34375,97.3211009 C68.7451843,95.119255 67.4549328,92.6307478 66.4729567,89.8555046 C65.4909807,87.0802614 65,83.9036876 65,80.3256881 C65,77.2522782 65.5252351,74.1559789 66.5757212,71.0366972 C67.6262072,67.9174156 69.0763129,64.9472618 70.9260817,62.1261468 C72.7758506,59.3050318 74.9567182,56.6674435 77.46875,54.2133028 C79.9807818,51.759162 82.6983027,49.6261558 85.6213942,47.8142202 C88.5444858,46.0022845 91.5931332,44.5802804 94.7674279,43.5481651 C97.9417226,42.5160499 101.127388,42 104.324519,42 C107.064918,42 109.531239,42.4357755 111.723558,43.3073394 C113.915876,44.1789034 115.765617,45.4059554 117.272837,46.9885321 C118.780056,48.5711088 119.944707,50.4747595 120.766827,52.6995413 C121.588946,54.9243231 122,57.4128303 122,60.1651376 C122,62.7798296 121.543274,65.3486112 120.629808,67.8715596 C119.716342,70.394508 118.506017,72.7798053 116.998798,75.0275229 C115.491579,77.2752406 113.790274,79.3509079 111.894832,81.2545872 C109.99939,83.1582664 108.058303,84.809626 106.071514,86.2087156 C104.084726,87.6078052 102.155057,88.6972438 100.282452,89.4770642 C98.4098464,90.2568846 96.7656321,90.646789 95.3497596,90.646789 C94.1165804,90.646789 93.0090193,90.3600946 92.0270433,89.7866972 C91.0450672,89.2132999 90.22296,88.5022978 89.5606971,87.6536697 C88.8984342,86.8050416 88.3846172,85.9105552 88.0192308,84.9701835 C87.6538443,84.0298118 87.4711538,83.1926642 87.4711538,82.4587156 C87.4711538,81.8623823 87.5510809,81.472478 87.7109375,81.2889908 C87.8707941,81.1055037 88.0991572,81.0252292 88.3960337,81.0481651 C88.6929101,81.071101 89.0697093,81.1399077 89.5264423,81.2545872 C89.9831754,81.3692666 90.5084105,81.4266055 91.1021635,81.4266055 C93.0204423,81.4266055 95.1442191,80.7614745 97.4735577,79.4311927 C99.8028963,78.1009108 101.995182,76.40368 104.050481,74.3394495 C106.10578,72.275219 107.829921,70.0045995 109.222957,67.5275229 C110.615993,65.0504463 111.3125,62.6422135 111.3125,60.3027523 C111.3125,57.9174193 110.730174,56.0367041 109.565505,54.6605505 C108.400836,53.2843968 106.425495,52.5963303 103.639423,52.5963303 C101.903837,52.5963303 100.019842,52.9288958 97.9873798,53.5940367 C95.9549177,54.2591776 93.911068,55.1880674 91.8557692,56.3807339 C89.8004705,57.5734005 87.8137115,59.0183401 85.8954327,60.7155963 C83.9771539,62.4128525 82.2872669,64.2820999 80.8257212,66.3233945 C79.3641754,68.3646891 78.1881054,70.5665019 77.297476,72.9288991 C76.4068465,75.2912962 75.9615385,77.7568679 75.9615385,80.3256881 C75.9615385,83.0321236 76.4525191,85.4518242 77.4344952,87.5848624 C78.4164713,89.7179006 79.7181409,91.6559546 81.3395433,93.3990826 C82.9609456,95.1422106 84.7992686,96.7476991 86.8545673,98.2155963 C88.909866,99.6834936 91.0108066,101.139901 93.1574519,102.584862 C95.3040973,104.029824 97.4050378,105.520635 99.4603365,107.057339 C101.515635,108.594044 103.353958,110.291275 104.975361,112.149083 C106.596763,114.00689 107.898433,116.07109 108.880409,118.341743 C109.862385,120.612397 110.353365,123.215582 110.353365,126.151376 C110.353365,128.995427 109.816712,131.690354 108.743389,134.236239 C107.670067,136.782123 106.197125,138.995403 104.324519,140.876147 C102.451914,142.75689 100.236792,144.247701 97.6790865,145.348624 C95.1213814,146.449547 92.3810242,147 89.4579327,147 Z" id="Scatter" fill="#62d0fd"></path>
              </g>
            </g>
          </g>
        </svg>
      </section>

      <section class="contract">
        <h1>Transfer Funds</h1>

        <p>
          This website is a EOSIO/Scatter boilerplate demo ( using eosjs@16.0.9 ). You can use it to understand how Scatter should be implemented,
          and how EOSIO interacts with a user's Scatter.
        </p>
        <br>

        <section v-if="scatter && account">
          <button @click="transferFunds">
            <span v-if="!sending">Send 1 EOS to Yourself</span>
            <i class="fa fa-spinner fa-spin" v-if="sending"></i>
          </button>

          <br>
          <br>
          <button class="small" :class="{'grey':transferType !== 'builtin'}" @click="transferType = 'builtin'">Builtin Transfer</button>
          <button class="small" :class="{'grey':transferType !== 'contract'}" @click="transferType = 'contract'">Contract Transfer</button>
          <button class="small" :class="{'grey':transferType !== 'transaction'}" @click="transferType = 'transaction'">Transaction Transfer</button>

          <section v-if="result">
            <br>
            {{result}}
          </section>
        </section>

        <button @click="login" v-if="scatter && !account">Login with Scatter</button>
        <section class="logged-in-with" v-if="scatter && account">
          Logged in with: {{account.name}}
          <button class="small" @click="logout">Logout</button>
        </section>

        <section v-if="!scatter">
          You need Scatter to interact with this website.
          <a href="https://get-scatter.com/" target="_blank">Click here to get it.</a>
        </section>
      </section>

    </section>

  </section>
</template>

<script>


    // Importing Scatter and eosjs.
    import ScatterJS, {Network} from 'scatterjs-core';
    import ScatterEOS from 'scatterjs-plugin-eosjs';
    import Eos from 'eosjs';


    // Scatter comes without plugins, so we need to add the eosjs plugin.
    ScatterJS.plugins( new ScatterEOS() );


    // Let's also define the network we will be using to connect.
    // https://get-scatter.com/docs/networks
    // -------------------------------------------------
    // OPTIONAL: ScatterJS exports another class called Network which is a useful helper
    // https://github.com/GetScatter/scatter-js/blob/master/packages/core/src/models/Network.js
    const network = Network.fromJson({
        blockchain:'eos',
        host:'nodes.get-scatter.com',
        port:443,
        protocol:'https',
        chainId:'aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906' // <-- this is the MAINNET
    });


    // Notice that our eosjs reference isn't reactive ( in the data() method like the rest ).
    // You don't want to set it onto the data of this component,
    // but you CAN set it as a VUEX state property if you wanted.
    let eos;

    export default {

        data(){return {
            sending:false,
            scatter:null,
            result:null,
            transferType:'builtin'
        }},

        mounted(){
            // We're going to setup eosjs now.
            this.setEosInstance();


            // Let's try connecting to Scatter first to make sure the user has Scatter installed.
            // https://get-scatter.com/docs/setting-up-for-web-apps
            ScatterJS.scatter.connect('YOUR_APP_NAME').then(connected => {
                if(!connected){
                    // Either the user doesn't have Scatter, or it's closed.
                    console.error('Could not connect to Scatter.');
                    return;
                }

                // If we are connected, let's make a reference to the Scatter object now.
                this.scatter = ScatterJS.scatter;
            })
        },

        computed:{
            // We're going to set up a helper to get the account we want to
            // interact with.
            account(){
                // No scatter or no Identity/Login yet
                if(!this.scatter || !this.scatter.identity) return null;

                // Returning the EOSIO account
                return this.scatter.identity.accounts[0];
            },
        },


        methods:{
            login(){
                // https://get-scatter.com/docs/api-get-identity
                // https://get-scatter.com/docs/requirable-fields

                // Here we're telling Scatter we want access to an account with the network we're connecting to.
                // Scatter will ask the user to use an account linked to the blockchain and CHAIN_ID you specify.
                this.scatter.getIdentity({accounts:[network]});

                // If the user accepts this prompt, then `scatter.identity` will fill itself.

            },
            logout(){
                // https://get-scatter.com/docs/api-forget-identity
                this.scatter.forgetIdentity();
            },
            transferFunds(){
                this.sending = true;
                // You need to pass in options, to make sure eosjs knows which authority/permission to use.
                const options = { authorization:[`${this.account.name}@${this.account.authority}`] };

                // We're just setting up a method that puts the result onto the page,
                // and sets the sending prop to false. NOTICE THE .then/.catch PLACEMENTS!
                const completed = res => {
                    this.result = res;
                    this.sending = false;
                }

                // There's three different ways you can call the transfer method.
                // NOTE: The `safetransfer` contract will just circle the funds back to you if you set the 'memo' parameter to the sender.

                if(this.transferType === 'builtin'){
                    // Using the built-in transfer method.
                    eos.transfer(this.account.name, 'safetransfer', '1.0000 EOS', this.account.name, options)
                        .then(completed).catch(completed)
                }

                if(this.transferType === 'contract'){
                    // Using the contract method ( will work for your own contracts )
                    eos.contract('eosio.token').then(contract => {
                        contract.transfer(this.account.name, 'safetransfer', '1.0000 EOS', this.account.name, options)
                            .then(completed).catch(completed);
                    })
                }

                if(this.transferType === 'transaction'){
                    // Using the `transaction` method, if any of these fails, all of them will fail.
                    eos.transaction(['eosio.token'], contracts => {
                        contracts.eosio_token.transfer(this.account.name, 'safetransfer', '1.0000 EOS', this.account.name, options);
                        contracts.eosio_token.transfer(this.account.name, 'safetransfer', '2.0000 EOS', this.account.name, options);
                    }, options).then(completed).catch(completed)
                }
            },


            setEosInstance(){
                if(this.account){
                    // Since we have a user with Scatter we're going to overwrite the eosjs instance
                    // with one that can sign transactions with Scatter.
                    eos = this.scatter.eos(network, Eos);
                } else {
                    // There is no user, so we're using a fallback eosjs instance so we can still fetch things
                    // from chain.
                    eos = Eos({httpEndpoint:network.fullhost()});
                }
            },
        },
        watch:{

            // We're watching the computed 'account' property we set up above.
            // If it changes we call the instance setter. We're doing this because
            // scatter could already have permissions for your website, and putting this
            // on the `mounted()` function which happens when this component is created might
            // not catch the identity changing.
            ['account'](){
                this.setEosInstance();
            }
        }
    }
</script>

<style scoped lang="scss">

  body {
    padding:0;
    margin:0;
  }

  .example {
    min-height: 100vh;
    width:100%;

    .container {
      margin:100px auto;
      text-align:center;
      display:inline-block;
    }

    .contract {
      max-width:600px;
      margin:0 auto 100px;
    }

    .messages {
      width:100%;

      .message {
        width:100%;
        display:flex;
        border-bottom:1px solid rgba(0,0,0,0.1);
        padding:10px 20px;
        text-align:left;

        .col {
          flex:1;
        }
      }
    }

    h1 {
      font-size: 36px;
      margin:20px 0;
    }

    .scatter-logo {
      width:100px;
      height:100px;
      display:inline-block;
    }

    .logged-in-with {
      position: absolute;
      top:20px;
      left:0;
      right:0;
      text-align: center;
      font-weight: bold;
      font-size: 13px;
    }

    button {
      cursor: pointer;
      background:#39ADFF;
      outline:0;
      border:0;
      color:#fff;
      height:50px;
      padding:0 20px;
      font-size: 22px;
      vertical-align: middle;
      box-shadow:inset 0 0 0 0 #39ADFF;
      transition: all 0.2s ease;
      transition-property: box-shadow, color, background;

      &.small {
        height:28px;
        padding:0 10px;
        font-size: 11px;
        margin-left:5px;

        &.grey {
          background:rgba(0,0,0,0.3);
          &:hover {
            background:transparent;
          }
        }
      }

      &:hover {
        background:transparent;
        box-shadow:inset 0 0 0 5px #39ADFF;
        color:#39ADFF;

      }
    }

    input {
      height:50px;
      padding:0 20px;
      border:0;
      outline:0;
      vertical-align: middle;
      box-shadow:inset 0 0 1px rgba(0,0,0,0.7);
    }

  }


</style>